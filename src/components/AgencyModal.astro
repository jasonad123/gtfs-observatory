---
import type { ProcessedFeed } from '../lib/types';

interface Props {
  agencyId: string;
  agencyName: string;
  website?: string;
  feeds: ProcessedFeed[];
}

const { agencyId, agencyName, website, feeds } = Astro.props;

const staticFeeds = feeds.filter(f => f.type === 'gtfs');
const realtimeFeeds = feeds.filter(f => f.type === 'gtfs_rt');

function formatDate(dateString?: string): string {
  if (!dateString) return 'Unknown';
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    timeZone: 'America/New_York'
  });
}

function getRealtimeTypeLabel(type: string): string {
  const labels: Record<string, string> = {
    'vp': 'Vehicle Positions',
    'tu': 'Trip Updates',
    'sa': 'Service Alerts'
  };
  return labels[type] || type;
}

function getAuthenticationLabel(type: number): string {
  const labels: Record<number, string> = {
    0: 'No authentication',
    1: 'API key (URL parameter)',
    2: 'API key (HTTP header)'
  };
  return labels[type] || 'Authentication required';
}
---

<dialog id={`modal-${agencyId}`} class="agency-modal">
  <article>
    <header>
      <a href="#close" aria-label="Close" rel="prev" class="close-modal"></a>
      <h2>{agencyName}</h2>
      <div class="modal-header-links">
        {website && (
          <a href={website} target="_blank" rel="noopener">
            Visit Agency Website
          </a>
        )}
        <a href={`https://mobilitydatabase.org/?feeds=${encodeURIComponent(agencyName)}`} target="_blank" rel="noopener" class="search-link">
          Search on MobilityData
        </a>
      </div>
    </header>

    {staticFeeds.length > 0 && (
      <section class="feed-section">
        <h3>GTFS Schedule Feeds</h3>
        {staticFeeds.map(feed => (
          <div class="feed-item">
            <div class="feed-header">
              <h4>{feed.name}</h4>
              <div class="feed-badges">
                <span class={`feed-status status-${feed.status}`}>
                  {feed.status}
                </span>
                {feed.official && (
                  <span class="official-badge">Official</span>
                )}
              </div>
            </div>
            
            {feed.note && (
              <p class="feed-note">{feed.note}</p>
            )}

            <div class="feed-details">
              <p class="feed-meta">
                <strong>Last updated:</strong> {formatDate(feed.lastUpdated)}
              </p>

              {feed.locations && feed.locations.length > 0 && (
                <p class="feed-meta">
                  <strong>Service area:</strong> {feed.locations.map(loc => 
                    [loc.municipality, loc.subdivision_name, loc.country].filter(Boolean).join(', ')
                  ).join(' • ')}
                </p>
              )}

              {feed.validation && (
                <div class="validation-summary">
                  <strong>Validation:</strong>
                  <div class="validation-pills">
                    <span class={`validation-pill ${feed.validation.unique_error_count > 0 ? 'validation-pill-error' : 'validation-pill-success'}`}>
                      <img
                        src={feed.validation.unique_error_count > 0 ? '/icons/ix--warning-octagon.svg' : '/icons/ix--success.svg'}
                        alt=""
                        class="validation-icon"
                        aria-hidden="true"
                      />
                      {feed.validation.unique_error_count} errors
                    </span>
                    <span class="validation-pill validation-pill-warning">
                      <img
                        src="/icons/ix--alarm.svg"
                        alt=""
                        class="validation-icon"
                        aria-hidden="true"
                      />
                      {feed.validation.unique_warning_count} warnings
                    </span>
                    <span class="validation-pill validation-pill-info">
                      <img
                        src="/icons/ix--about.svg"
                        alt=""
                        class="validation-icon"
                        aria-hidden="true"
                      />
                      {feed.validation.unique_info_count} info notices
                    </span>
                  </div>
                  {feed.validation.url_html && (
                    <a href={feed.validation.url_html} target="_blank" rel="noopener" class="validation-link">
                      View report
                    </a>
                  )}
                </div>
              )}

              {feed.authentication && feed.authentication.type > 0 && (
                <p class="feed-meta auth-info">
                  <strong>
                    <img src="/icons/ix--user-lock.svg" alt="" class="auth-icon" aria-hidden="true" />
                    Authentication:
                  </strong> {getAuthenticationLabel(feed.authentication.type)}
                  {feed.authentication.infoUrl && (
                    <>
                      {' '}
                      <a href={feed.authentication.infoUrl} target="_blank" rel="noopener">
                        Details
                      </a>
                    </>
                  )}
                </p>
              )}

              {feed.license && (
                <p class="feed-meta">
                  <strong>License:</strong>
                  {feed.license.url ? (
                    <a href={feed.license.url} target="_blank" rel="noopener">
                      {feed.license.id || 'View License'}
                    </a>
                  ) : feed.license.id || 'See provider'}
                  {feed.license.isSpdx && ' (SPDX)'}
                </p>
              )}
            </div>

            <div class="download-options">
              {feed.downloadUrls.mobilityData && (
                <a
                  href={feed.downloadUrls.mobilityData}
                  class="download-btn"
                  download
                  role="button"
                >
                  <img src="/icons/ix--cloud-download.svg" alt="" class="btn-icon" aria-hidden="true" />
                  Download (MobilityData)
                </a>
              )}
              {feed.downloadUrls.direct && (
                <a
                  href={feed.downloadUrls.direct}
                  class="download-btn secondary"
                  target="_blank"
                  rel="noopener"
                  role="button"
                >
                  <img src="/icons/ix--download.svg" alt="" class="btn-icon" aria-hidden="true" />
                  {feed.authentication?.type ? 'Access Direct (Auth Required)' : 'Download (Direct)'}
                </a>
              )}
              {feed.id && (
                <a
                  href={`https://mobilitydatabase.org/feeds/${feed.id}`}
                  class="feed-link-btn"
                  target="_blank"
                  rel="noopener"
                  role="button"
                >
                  View on MobilityData
                </a>
              )}
            </div>
          </div>
        ))}
      </section>
    )}

    {realtimeFeeds.length > 0 && (
      <section class="feed-section">
        <h3>GTFS Realtime Feeds</h3>
        {realtimeFeeds.map(feed => (
          <div class="feed-item">
            <div class="feed-header">
              <h4>{feed.name}</h4>
              <div class="feed-badges">
                <span class={`feed-status status-${feed.status}`}>
                  {feed.status}
                </span>
                {feed.official && (
                  <span class="official-badge">Official</span>
                )}
              </div>
            </div>

            {feed.note && (
              <p class="feed-note">{feed.note}</p>
            )}

            <div class="feed-details">
              {feed.realtimeTypes && feed.realtimeTypes.length > 0 && (
                <p class="feed-meta">
                  <strong>Types:</strong> {feed.realtimeTypes.map(getRealtimeTypeLabel).join(', ')}
                </p>
              )}

              {feed.locations && feed.locations.length > 0 && (
                <p class="feed-meta">
                  <strong>Service area:</strong> {feed.locations.map(loc => 
                    [loc.municipality, loc.subdivision_name].filter(Boolean).join(', ')
                  ).join(' • ')}
                </p>
              )}

              {feed.feedReferences && feed.feedReferences.length > 0 && (
                <p class="feed-meta">
                  <strong>Associated GTFS feeds:</strong> {feed.feedReferences.join(', ')}
                </p>
              )}

              {feed.authentication && feed.authentication.type > 0 && (
                <p class="feed-meta auth-info">
                  <strong>
                    <img src="/icons/ix--user-lock.svg" alt="" class="auth-icon" aria-hidden="true" />
                    Authentication:
                  </strong> {getAuthenticationLabel(feed.authentication.type)}
                  {feed.authentication.infoUrl && (
                    <>
                      {' '}
                      <a href={feed.authentication.infoUrl} target="_blank" rel="noopener">
                        Details
                      </a>
                    </>
                  )}
                </p>
              )}
            </div>

            <div class="download-options">
              {feed.downloadUrls.direct && (
                <a
                  href={feed.downloadUrls.direct}
                  class="download-btn"
                  target="_blank"
                  rel="noopener"
                  role="button"
                >
                  <img src="/icons/ix--download.svg" alt="" class="btn-icon" aria-hidden="true" />
                  {feed.authentication?.type ? 'Access Feed URL (Auth Required)' : 'Access Feed URL'}
                </a>
              )}
            </div>
          </div>
        ))}
      </section>
    )}

    {feeds.length === 0 && (
      <p>No feeds currently available for this agency.</p>
    )}
  </article>
</dialog>

<style>
  .agency-modal {
    max-width: 800px;
  }

  .agency-modal header {
    padding: 2rem 2rem 1rem;
  }

  .agency-modal header h2 {
    margin-bottom: 0.75rem;
  }

  .modal-header-links {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    font-size: 0.9rem;
  }

  .modal-header-links a {
    color: var(--pico-primary);
  }

  .search-link {
    color: var(--pico-muted-color);
  }

  .feed-section {
    margin: 3rem 0;
  }

  .feed-section h3 {
    margin-bottom: 1rem;
    margin-left: 0.25rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--pico-muted-border-color);
  }

  .feed-item {
    padding: 1.5rem;
    margin-bottom: 1rem;
    border: 1px solid var(--pico-muted-border-color);
    border-radius: var(--pico-border-radius);
  }

  .feed-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.5rem;
  }

  .feed-header h4 {
    margin: 0;
    font-size: 1.1rem;
  }

  .feed-badges {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .feed-status {
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    white-space: nowrap;
  }

  .status-active {
    background-color: #d4edda;
    color: #0d3d18;
  }

  .status-inactive, .status-deprecated {
    background-color: #f8d7da;
    color: #5a0f19;
  }

  .status-development {
    background-color: #fff3cd;
    color: #6b5103;
  }

  .official-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    font-weight: 600;
    background-color: #cfe2ff;
    color: #084298;
  }

  .feed-note {
    margin: 0.5rem 0;
    padding: 0.5rem;
    background-color: var(--pico-code-background-color);
    border-radius: 0.25rem;
    font-size: 0.875rem;
  }

  .feed-details {
    margin: 1rem 0;
  }

  .feed-meta {
    margin: 0.5rem 0;
    font-size: 0.875rem;
  }

  .auth-info {
    color: var(--pico-del-color);
  }

  .auth-icon {
    width: 1em;
    height: 1em;
    display: inline-block;
    vertical-align: text-bottom;
    margin-right: 0.25rem;
  }

  .validation-summary {
    margin: 0.5rem 0;
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .validation-pills {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .validation-pill {
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    font-weight: 600;
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
  }

  .validation-icon {
    width: 1em;
    height: 1em;
    display: inline-block;
  }

  .validation-pill-error {
    background-color: #f4b5ba;
    color: #5a0f19;
  }

  .validation-pill-success {
    background-color: #8be29f;
    color: #0d3d18;
  }

  .validation-pill-warning {
    background-color: #f0db95;
    color: #6b5103;
  }

  .validation-pill-info {
    background-color: #95adb2;
    color: #0c5460;
  }

  .validation-link {
    font-size: 0.875rem;
  }

  .download-options {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
    flex-wrap: wrap;
  }

  .download-btn {
    margin: 0;
    white-space: nowrap;
    font-size: 0.875rem;
    padding: 0.5rem 0.875rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .btn-icon {
    width: 1.2em;
    height: 1.2em;
    display: inline-block;
  }

  .feed-link-btn {
    margin: 0;
    white-space: nowrap;
    font-size: 0.875rem;
    padding: 0.5rem 0.875rem;
    background-color: #5d68c4;
    border-color: #5d68c4;
  }

  .feed-link-btn:hover {
    background-color: #4d5bb5;
    border-color: #4d5bb5;
  }

  .close-modal {
    float: right;
  }
</style>
