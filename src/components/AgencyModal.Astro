---
import type { ProcessedFeed } from '../lib/types';

interface Props {
  agencyId: string;
  agencyName: string;
  website?: string;
  feeds: ProcessedFeed[];
}

const { agencyId, agencyName, website, feeds } = Astro.props;

const staticFeeds = feeds.filter(f => f.type === 'gtfs');
const realtimeFeeds = feeds.filter(f => f.type === 'gtfs_rt');

function formatDate(dateString?: string): string {
  if (!dateString) return 'Unknown';
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    timeZone: 'America/New_York'
  });
}

function getRealtimeTypeLabel(type: string): string {
  const labels: Record<string, string> = {
    'vp': 'Vehicle Positions',
    'tu': 'Trip Updates',
    'sa': 'Service Alerts'
  };
  return labels[type] || type;
}

function getAuthenticationLabel(type: number): string {
  const labels: Record<number, string> = {
    0: 'No authentication',
    1: 'API key (URL parameter)',
    2: 'API key (HTTP header)'
  };
  return labels[type] || 'Authentication required';
}
---

<dialog id={`modal-${agencyId}`} class="agency-modal">
  <article>
    <header>
      <button aria-label="Close" rel="prev" class="close-modal"></button>
      <h2>{agencyName}</h2>
      {website && (
        <p>
          <a href={website} target="_blank" rel="noopener">
            Visit Agency Website
          </a>
        </p>
      )}
    </header>

    {staticFeeds.length > 0 && (
      <section class="feed-section">
        <h3>GTFS Schedule Feeds</h3>
        {staticFeeds.map(feed => (
          <div class="feed-item">
            <div class="feed-header">
              <h4>{feed.name}</h4>
              <div class="feed-badges">
                <span class={`feed-status status-${feed.status}`}>
                  {feed.status}
                </span>
                {feed.official && (
                  <span class="official-badge">Official</span>
                )}
              </div>
            </div>
            
            {feed.note && (
              <p class="feed-note">{feed.note}</p>
            )}

            <div class="feed-details">
              <p class="feed-meta">
                <strong>Last updated:</strong> {formatDate(feed.lastUpdated)}
              </p>

              {feed.locations && feed.locations.length > 0 && (
                <p class="feed-meta">
                  <strong>Service area:</strong> {feed.locations.map(loc => 
                    [loc.municipality, loc.subdivision_name, loc.country].filter(Boolean).join(', ')
                  ).join(' • ')}
                </p>
              )}

              {feed.validation && (
                <div class="validation-summary">
                  <strong>Validation:</strong>
                  <span class={feed.validation.total_error > 0 ? 'validation-errors' : 'validation-ok'}>
                    {feed.validation.total_error} errors
                  </span>
                  • <span>{feed.validation.total_warning} warnings</span>
                  • <span>{feed.validation.total_info} info</span>
                  {feed.validation.url_html && (
                    <a href={feed.validation.url_html} target="_blank" rel="noopener" class="validation-link">
                      View Report
                    </a>
                  )}
                </div>
              )}

              {feed.authentication && feed.authentication.type > 0 && (
                <p class="feed-meta auth-info">
                  <strong>⚠️ Authentication:</strong> {getAuthenticationLabel(feed.authentication.type)}
                  {feed.authentication.infoUrl && (
                    <>
                      {' '}
                      <a href={feed.authentication.infoUrl} target="_blank" rel="noopener">
                        Details
                      </a>
                    </>
                  )}
                </p>
              )}

              {feed.license && (
                <p class="feed-meta">
                  <strong>License:</strong>
                  {feed.license.url ? (
                    <a href={feed.license.url} target="_blank" rel="noopener">
                      {feed.license.id || 'View License'}
                    </a>
                  ) : feed.license.id || 'See provider'}
                  {feed.license.isSpdx && ' (SPDX)'}
                </p>
              )}
            </div>

            <div class="download-options">
              {feed.downloadUrls.mobilityData && (
                <a 
                  href={feed.downloadUrls.mobilityData} 
                  class="download-btn"
                  download
                  role="button"
                >
                  Download (MobilityData)
                </a>
              )}
              {feed.downloadUrls.direct && (
                <a 
                  href={feed.downloadUrls.direct} 
                  class="download-btn secondary"
                  target="_blank"
                  rel="noopener"
                  role="button"
                >
                  {feed.authentication?.type ? 'Access Direct (Auth Required)' : 'Download (Direct)'}
                </a>
              )}
            </div>
          </div>
        ))}
      </section>
    )}

    {realtimeFeeds.length > 0 && (
      <section class="feed-section">
        <h3>GTFS Realtime Feeds</h3>
        {realtimeFeeds.map(feed => (
          <div class="feed-item">
            <div class="feed-header">
              <h4>{feed.name}</h4>
              <div class="feed-badges">
                <span class={`feed-status status-${feed.status}`}>
                  {feed.status}
                </span>
                {feed.official && (
                  <span class="official-badge">Official</span>
                )}
              </div>
            </div>

            {feed.note && (
              <p class="feed-note">{feed.note}</p>
            )}

            <div class="feed-details">
              {feed.realtimeTypes && feed.realtimeTypes.length > 0 && (
                <p class="feed-meta">
                  <strong>Types:</strong> {feed.realtimeTypes.map(getRealtimeTypeLabel).join(', ')}
                </p>
              )}

              {feed.locations && feed.locations.length > 0 && (
                <p class="feed-meta">
                  <strong>Service area:</strong> {feed.locations.map(loc => 
                    [loc.municipality, loc.subdivision_name].filter(Boolean).join(', ')
                  ).join(' • ')}
                </p>
              )}

              {feed.feedReferences && feed.feedReferences.length > 0 && (
                <p class="feed-meta">
                  <strong>Associated GTFS feeds:</strong> {feed.feedReferences.join(', ')}
                </p>
              )}

              {feed.authentication && feed.authentication.type > 0 && (
                <p class="feed-meta auth-info">
                  <strong>⚠️ Authentication:</strong> {getAuthenticationLabel(feed.authentication.type)}
                  {feed.authentication.infoUrl && (
                    <>
                      {' '}
                      <a href={feed.authentication.infoUrl} target="_blank" rel="noopener">
                        Details
                      </a>
                    </>
                  )}
                </p>
              )}
            </div>

            <div class="download-options">
              {feed.downloadUrls.direct && (
                <a 
                  href={feed.downloadUrls.direct} 
                  class="download-btn"
                  target="_blank"
                  rel="noopener"
                  role="button"
                >
                  {feed.authentication?.type ? 'Access Feed URL (Auth Required)' : 'Access Feed URL'}
                </a>
              )}
            </div>
          </div>
        ))}
      </section>
    )}

    {feeds.length === 0 && (
      <p>No feeds currently available for this agency.</p>
    )}
  </article>
</dialog>

<style>
  .agency-modal {
    max-width: 800px;
  }

  .agency-modal header h2 {
    margin-bottom: 0.5rem;
  }

  .feed-section {
    margin: 2rem 0;
  }

  .feed-section h3 {
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--pico-muted-border-color);
  }

  .feed-item {
    padding: 1.5rem;
    margin-bottom: 1rem;
    border: 1px solid var(--pico-muted-border-color);
    border-radius: var(--pico-border-radius);
  }

  .feed-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.5rem;
  }

  .feed-header h4 {
    margin: 0;
    font-size: 1.1rem;
  }

  .feed-badges {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .feed-status {
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    white-space: nowrap;
  }

  .status-active {
    background-color: #d4edda;
    color: #155724;
  }

  .status-inactive, .status-deprecated {
    background-color: #f8d7da;
    color: #721c24;
  }

  .status-development {
    background-color: #fff3cd;
    color: #856404;
  }

  .official-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    font-weight: 600;
    background-color: #cfe2ff;
    color: #084298;
  }

  .feed-note {
    margin: 0.5rem 0;
    padding: 0.5rem;
    background-color: var(--pico-code-background-color);
    border-radius: 0.25rem;
    font-size: 0.875rem;
  }

  .feed-details {
    margin: 1rem 0;
  }

  .feed-meta {
    margin: 0.5rem 0;
    font-size: 0.875rem;
  }

  .auth-info {
    color: var(--pico-del-color);
  }

  .validation-summary {
    margin: 0.5rem 0;
    font-size: 0.875rem;
  }

  .validation-errors {
    color: var(--pico-del-color);
    font-weight: 600;
  }

  .validation-ok {
    color: var(--pico-ins-color);
    font-weight: 600;
  }

  .validation-link {
    margin-left: 0.5rem;
    font-size: 0.875rem;
  }

  .download-options {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
    flex-wrap: wrap;
  }

  .download-btn {
    margin: 0;
    white-space: nowrap;
  }

  .close-modal {
    float: right;
  }
</style>