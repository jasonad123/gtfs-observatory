---
import DashboardLayout from '../layouts/DashboardLayout.astro';
import Navigation from '../components/Navigation.astro';
import AgencyCard from '../components/AgencyCard.astro';
import AgencyModal from '../components/AgencyModal.astro';
import { getDCFeeds } from '../lib/agencies';

let agencies;
let error;

try {
  agencies = await getDCFeeds();
} catch (e) {
  error = e instanceof Error ? e.message : 'Failed to load feeds';
  console.error('Error loading feeds:', e);
}
---

<DashboardLayout title="Feeds - GTFS Observatory">
  <Navigation currentPath="/" />

  <header class="page-header">
    <h1>GTFS Observatory</h1>
    <p>Explore the state of transit data in the your area</p>
  </header>

  {error ? (
    <div class="error-state">
      <h2>Unable to Load Feeds</h2>
      <p>{error}</p>
      <p>Visitors: please contact the maintainer of this project for further assistance.</p>
      <p>Maintainers: Please check your environment configuration and try again.</p>
    </div>
  ) : agencies && agencies.length > 0 ? (
    <>
      <div class="agency-grid">
        {agencies.map(agency => {
          const activeFeeds = agency.feeds.filter(f => f.status !== 'deprecated' && f.status !== 'inactive');
          const inactiveDeprecatedFeeds = agency.feeds.filter(f => f.status === 'deprecated' || f.status === 'inactive');
          const activeFeedCount = activeFeeds.length;
          const displayCount = activeFeedCount > 0 ? activeFeedCount : agency.feeds.length;
          const gtfsScheduleCount = activeFeeds.filter(f => f.type === 'gtfs').length;
          const gtfsRealtimeCount = activeFeeds.filter(f => f.type === 'gtfs_rt').length;
          return (
            <AgencyCard
              agencyId={agency.id}
              name={agency.name}
              activeFeedCount={displayCount}
              gtfsScheduleCount={gtfsScheduleCount}
              gtfsRealtimeCount={gtfsRealtimeCount}
              inactiveDeprecatedCount={inactiveDeprecatedFeeds.length}
              status={agency.overallStatus}
              website={agency.website}
              logo={agency.logo}
              color={agency.color}
              secondaryColor={agency.secondaryColor}
              textColor={agency.textColor}
              showName={agency.showName}
            />
          );
        })}
      </div>

      {agencies.map(agency => (
        <AgencyModal
          agencyId={agency.id}
          agencyName={agency.name}
          website={agency.website}
          logo={agency.logo}
          color={agency.color}
          secondaryColor={agency.secondaryColor}
          textColor={agency.textColor}
          showName={agency.showName}
          feeds={agency.feeds}
        />
      ))}
    </>
  ) : (
    <div class="loading-state">
      <p>No feeds found. This could mean:</p>
      <ul>
        <li>The MobilityData API is temporarily unavailable</li>
        <li>No feeds match the region criteria</li>
        <li>Your API credentials need verification</li>
      </ul>
    </div>
  )}
</DashboardLayout>

<script>
  import { initModals } from '../scripts/modal';
  initModals();
</script>
