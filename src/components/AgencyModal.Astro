---
import type { ProcessedFeed } from '../lib/types';

interface Props {
  agencyId: string;
  agencyName: string;
  website?: string;
  feeds: ProcessedFeed[];
}

const { agencyId, agencyName, website, feeds } = Astro.props;

const staticFeeds = feeds.filter(f => f.type === 'gtfs');
const realtimeFeeds = feeds.filter(f => f.type === 'gtfs_rt');

function formatDate(dateString?: string): string {
  if (!dateString) return 'Unknown';
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    timeZone: 'America/New_York'
  });
}

function getRealtimeTypeLabel(type: string): string {
  const labels: Record<string, string> = {
    'vp': 'Vehicle Positions',
    'tu': 'Trip Updates',
    'sa': 'Service Alerts'
  };
  return labels[type] || type;
}

function getAuthenticationLabel(type: number): string {
  const labels: Record<number, string> = {
    0: 'No authentication',
    1: 'API key (URL parameter)',
    2: 'API key (HTTP header)'
  };
  return labels[type] || 'Authentication required';
}
---

<dialog id={`modal-${agencyId}`} class="agency-modal">
  <article>
    <header>
      <button aria-label="Close" rel="prev" class="close-modal"></button>
      <h2>{agencyName}</h2>
      <div class="modal-header-links">
        {website && (
          <a href={website} target="_blank" rel="noopener">
            Visit Agency Website
          </a>
        )}
        <a href={`https://mobilitydatabase.org/?search=${encodeURIComponent(agencyName)}`} target="_blank" rel="noopener" class="search-link">
          Search on MobilityData
        </a>
      </div>
    </header>

    {staticFeeds.length > 0 && (
      <section class="feed-section">
        <h3>GTFS Schedule Feeds</h3>
        {staticFeeds.map(feed => (
          <div class="feed-item">
            <div class="feed-header">
              <h4>{feed.name}</h4>
              <div class="feed-badges">
                <span class={`feed-status status-${feed.status}`}>
                  {feed.status}
                </span>
                {feed.official && (
                  <span class="official-badge">Official</span>
                )}
              </div>
            </div>
            
            {feed.note && (
              <p class="feed-note">{feed.note}</p>
            )}

            <div class="feed-details">
              <p class="feed-meta">
                <strong>Last updated:</strong> {formatDate(feed.lastUpdated)}
              </p>

              {feed.locations && feed.locations.length > 0 && (
                <p class="feed-meta">
                  <strong>Service area:</strong> {feed.locations.map(loc => 
                    [loc.municipality, loc.subdivision_name, loc.country].filter(Boolean).join(', ')
                  ).join(' • ')}
                </p>
              )}

              {feed.validation && (
                <div class="validation-summary">
                  <strong>Validation:</strong>
                  <div class="validation-pills">
                    <span class={`validation-pill ${feed.validation.total_error > 0 ? 'validation-pill-error' : 'validation-pill-success'}`}>
                      {feed.validation.total_error} errors
                    </span>
                    <span class="validation-pill validation-pill-warning">
                      {feed.validation.total_warning} warnings
                    </span>
                    <span class="validation-pill validation-pill-info">
                      {feed.validation.total_info} info
                    </span>
                  </div>
                  {feed.validation.url_html && (
                    <a href={feed.validation.url_html} target="_blank" rel="noopener" class="validation-link">
                      View Report
                    </a>
                  )}
                </div>
              )}

              {feed.authentication && feed.authentication.type > 0 && (
                <p class="feed-meta auth-info">
                  <strong>
                    <svg class="auth-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                      <path fill="currentColor" fill-rule="evenodd" d="M213.333 42.665c41.238 0 74.667 33.43 74.667 74.667c0 39.862-31.238 72.429-70.57 74.556l-4.097.11c-41.237 0-74.666-33.429-74.666-74.666c0-39.863 31.238-72.43 70.57-74.556zm149.334 320.001h-.006V320l.144-2.488c1.232-10.61 10.249-18.846 21.19-18.846l2.488.144c10.61 1.232 18.845 10.249 18.845 21.19v42.666zm-64.006 21.332v-21.332h21.334v-42.667c0-16.788 6.464-32.067 17.039-43.483C348.724 263.898 365.437 256 383.995 256c35.346 0 64 28.653 64 64v42.666h21.333v106.667H298.661zm-47.994-149.333c27.181 0 52.1 9.959 71.497 26.523c-10.165 10.684-17.589 23.998-21.147 38.817c-11.838-13.062-28.253-21.497-46.442-22.559l-3.908-.114H176c-36.708 0-67.166 30.026-69.223 68.392l-.11 4.141v34.133h170.661v42.667H64v-76.8c0-62.033 47.668-112.614 107.383-115.104l4.617-.096zm-69.334-117.333c0-17.673 14.327-32 32-32s32 14.327 32 32s-14.327 32-32 32s-32-14.327-32-32" clip-rule="evenodd" />
                    </svg>
                    Authentication:
                  </strong> {getAuthenticationLabel(feed.authentication.type)}
                  {feed.authentication.infoUrl && (
                    <>
                      {' '}
                      <a href={feed.authentication.infoUrl} target="_blank" rel="noopener">
                        Details
                      </a>
                    </>
                  )}
                </p>
              )}

              {feed.license && (
                <p class="feed-meta">
                  <strong>License:</strong>
                  {feed.license.url ? (
                    <a href={feed.license.url} target="_blank" rel="noopener">
                      {feed.license.id || 'View License'}
                    </a>
                  ) : feed.license.id || 'See provider'}
                  {feed.license.isSpdx && ' (SPDX)'}
                </p>
              )}
            </div>

            <div class="download-options">
              {feed.downloadUrls.mobilityData && (
                <a
                  href={feed.downloadUrls.mobilityData}
                  class="download-btn"
                  download
                  role="button"
                >
                  Download (MobilityData)
                </a>
              )}
              {feed.downloadUrls.direct && (
                <a
                  href={feed.downloadUrls.direct}
                  class="download-btn secondary"
                  target="_blank"
                  rel="noopener"
                  role="button"
                >
                  {feed.authentication?.type ? 'Access Direct (Auth Required)' : 'Download (Direct)'}
                </a>
              )}
              {feed.id && (
                <a
                  href={`https://mobilitydatabase.org/feeds/${feed.id}`}
                  class="feed-link-btn"
                  target="_blank"
                  rel="noopener"
                  role="button"
                >
                  View on MobilityData
                </a>
              )}
            </div>
          </div>
        ))}
      </section>
    )}

    {realtimeFeeds.length > 0 && (
      <section class="feed-section">
        <h3>GTFS Realtime Feeds</h3>
        {realtimeFeeds.map(feed => (
          <div class="feed-item">
            <div class="feed-header">
              <h4>{feed.name}</h4>
              <div class="feed-badges">
                <span class={`feed-status status-${feed.status}`}>
                  {feed.status}
                </span>
                {feed.official && (
                  <span class="official-badge">Official</span>
                )}
              </div>
            </div>

            {feed.note && (
              <p class="feed-note">{feed.note}</p>
            )}

            <div class="feed-details">
              {feed.realtimeTypes && feed.realtimeTypes.length > 0 && (
                <p class="feed-meta">
                  <strong>Types:</strong> {feed.realtimeTypes.map(getRealtimeTypeLabel).join(', ')}
                </p>
              )}

              {feed.locations && feed.locations.length > 0 && (
                <p class="feed-meta">
                  <strong>Service area:</strong> {feed.locations.map(loc => 
                    [loc.municipality, loc.subdivision_name].filter(Boolean).join(', ')
                  ).join(' • ')}
                </p>
              )}

              {feed.feedReferences && feed.feedReferences.length > 0 && (
                <p class="feed-meta">
                  <strong>Associated GTFS feeds:</strong> {feed.feedReferences.join(', ')}
                </p>
              )}

              {feed.authentication && feed.authentication.type > 0 && (
                <p class="feed-meta auth-info">
                  <strong>
                    <svg class="auth-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                      <path fill="currentColor" fill-rule="evenodd" d="M213.333 42.665c41.238 0 74.667 33.43 74.667 74.667c0 39.862-31.238 72.429-70.57 74.556l-4.097.11c-41.237 0-74.666-33.429-74.666-74.666c0-39.863 31.238-72.43 70.57-74.556zm149.334 320.001h-.006V320l.144-2.488c1.232-10.61 10.249-18.846 21.19-18.846l2.488.144c10.61 1.232 18.845 10.249 18.845 21.19v42.666zm-64.006 21.332v-21.332h21.334v-42.667c0-16.788 6.464-32.067 17.039-43.483C348.724 263.898 365.437 256 383.995 256c35.346 0 64 28.653 64 64v42.666h21.333v106.667H298.661zm-47.994-149.333c27.181 0 52.1 9.959 71.497 26.523c-10.165 10.684-17.589 23.998-21.147 38.817c-11.838-13.062-28.253-21.497-46.442-22.559l-3.908-.114H176c-36.708 0-67.166 30.026-69.223 68.392l-.11 4.141v34.133h170.661v42.667H64v-76.8c0-62.033 47.668-112.614 107.383-115.104l4.617-.096zm-69.334-117.333c0-17.673 14.327-32 32-32s32 14.327 32 32s-14.327 32-32 32s-32-14.327-32-32" clip-rule="evenodd" />
                    </svg>
                    Authentication:
                  </strong> {getAuthenticationLabel(feed.authentication.type)}
                  {feed.authentication.infoUrl && (
                    <>
                      {' '}
                      <a href={feed.authentication.infoUrl} target="_blank" rel="noopener">
                        Details
                      </a>
                    </>
                  )}
                </p>
              )}
            </div>

            <div class="download-options">
              {feed.downloadUrls.direct && (
                <a 
                  href={feed.downloadUrls.direct} 
                  class="download-btn"
                  target="_blank"
                  rel="noopener"
                  role="button"
                >
                  {feed.authentication?.type ? 'Access Feed URL (Auth Required)' : 'Access Feed URL'}
                </a>
              )}
            </div>
          </div>
        ))}
      </section>
    )}

    {feeds.length === 0 && (
      <p>No feeds currently available for this agency.</p>
    )}
  </article>
</dialog>

<style>
  .agency-modal {
    max-width: 800px;
  }

  .agency-modal header {
    padding: 2rem 2rem 1rem;
  }

  .agency-modal header h2 {
    margin-bottom: 0.75rem;
  }

  .modal-header-links {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    font-size: 0.9rem;
  }

  .modal-header-links a {
    color: var(--pico-primary);
  }

  .search-link {
    color: var(--pico-muted-color);
  }

  .feed-section {
    margin: 3rem 0;
  }

  .feed-section h3 {
    margin-bottom: 1rem;
    margin-left: 0.25rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--pico-muted-border-color);
  }

  .feed-item {
    padding: 1.5rem;
    margin-bottom: 1rem;
    border: 1px solid var(--pico-muted-border-color);
    border-radius: var(--pico-border-radius);
  }

  .feed-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.5rem;
  }

  .feed-header h4 {
    margin: 0;
    font-size: 1.1rem;
  }

  .feed-badges {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .feed-status {
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    white-space: nowrap;
  }

  .status-active {
    background-color: #d4edda;
    color: #155724;
  }

  .status-inactive, .status-deprecated {
    background-color: #f8d7da;
    color: #721c24;
  }

  .status-development {
    background-color: #fff3cd;
    color: #856404;
  }

  .official-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    font-weight: 600;
    background-color: #cfe2ff;
    color: #084298;
  }

  .feed-note {
    margin: 0.5rem 0;
    padding: 0.5rem;
    background-color: var(--pico-code-background-color);
    border-radius: 0.25rem;
    font-size: 0.875rem;
  }

  .feed-details {
    margin: 1rem 0;
  }

  .feed-meta {
    margin: 0.5rem 0;
    font-size: 0.875rem;
  }

  .auth-info {
    color: var(--pico-del-color);
  }

  .auth-icon {
    width: 1em;
    height: 1em;
    display: inline-block;
    vertical-align: text-bottom;
    margin-right: 0.25rem;
  }

  .validation-summary {
    margin: 0.5rem 0;
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .validation-pills {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .validation-pill {
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    font-weight: 600;
    white-space: nowrap;
  }

  .validation-pill-error {
    background-color: #f8d7da;
    color: #721c24;
  }

  .validation-pill-success {
    background-color: #d4edda;
    color: #155724;
  }

  .validation-pill-warning {
    background-color: #fff3cd;
    color: #856404;
  }

  .validation-pill-info {
    background-color: #d1ecf1;
    color: #0c5460;
  }

  .validation-link {
    font-size: 0.875rem;
  }

  .download-options {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
    flex-wrap: wrap;
  }

  .download-btn {
    margin: 0;
    white-space: nowrap;
  }

  .feed-link-btn {
    margin: 0;
    white-space: nowrap;
    font-size: 0.875rem;
    padding: 0.5rem 0.875rem;
  }

  .close-modal {
    float: right;
  }
</style>
